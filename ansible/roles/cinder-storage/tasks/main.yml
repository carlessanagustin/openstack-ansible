---
- name: install cinder storage node components
  yum: name={{ item }} state=latest
  sudo: true
  with_items:
    - qemu
    - lvm2
    - openstack-cinder
    - targetcli
    - python-oslo-db
    - python-oslo-log
    - MySQL-python

- name: ensure lvm2-lvmetad  is running running
  sudo: true
  service: name={{ item }} state=started enabled=yes
  with_items:
    - lvm2-lvmetad

- name: write the cinder config file
  template: src=cinder.conf.j2 dest=/etc/cinder/cinder.conf backup=yes
  sudo: true
  notify:
    - restart cinder storage node services

- name: Trigger handlers
  meta: flush_handlers

- name: ensure cinder storage services are running
  sudo: true
  service: name={{ item }} state=started enabled=yes
  with_items:
    - openstack-cinder-volume
    - target

- name: restart cinder-storage components by handlers
  shell: echo 'Restarting cinder-storage components....'
  tags:
    - restart-components
  notify:
    - restart cinder storage node services